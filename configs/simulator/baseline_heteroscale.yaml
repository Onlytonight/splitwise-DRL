# HeteroScale 基线策略配置
algorithm: baseline_heteroscale

# 决策参数
decision_interval: 2  # 决策间隔（秒）

enabled_features:
#  - queue              # 队列特征 (p_queue, d_queue)
#  - none_count         # None计数 (prompt_none_count, token_none_count)
  - instance_count     # 实例数 (n_p, n_t) - 归一化资源状态
  - timestamp          # 时间戳
  - rps                # 请求到达率 - norm_arrival_token_rate
  - rps_delta          # RPS变化率 - traffic_trend
#  - length             # 长度特征 (prompt_len, output_len)
#  - rate               # 速率特征 (prompt_rate, token_rate)
  - util_mem           # 内存利用率 - d_memory_util_level
#  - draining           # 缩容状态
  - p_ins_pending_token  # P实例pending - p_saturation_level
#  - queue_delta        # 队列变化率
  - io_ratio           # 输入/输出长度比
  - avg_batch_tokens   # 平均批次token数
  - rejection_rate     # 拒绝率 (p_rejection_rate, d_rejection_rate)

stack_size: 1  # 状态堆叠的时间窗大小（基线策略通常不需要堆叠）

# 奖励函数权重（用于评估策略效果）
reward_weights:
  w_cost: 0.2
  w_queue: 1.5
  w_util: 1.0
  w_congestion: 1.0
  w_stability: 0.0
  w_slo: 0.0
  w_switch: 0.0

# 动作执行参数
action_scale_step: 20
action_mig_step: 20
min_instances_per_pool: 1
max_total_instances: 200

# 经验池保存配置（用于离线RL/预训练）
save_replay_buffer: true              # 是否保存经验池
replay_buffer_path: "data/replay_buffer_heteroscale.npz"  # 经验池保存路径
clear_replay_buffer_on_start: false   # 启动时是否清空已有经验池（false=追加模式，true=覆盖模式）

# HeteroScale 策略参数
# 基于性能测试结果（见 doc/TPS_CALCULATION_SUMMARY.md）：
# - Token 实例（A100）最大 TPS: 11,369 tokens/s @ batch_size=512
# - Prompt 实例（H100）最大 TPS: 15,440 tokens/s @ batch_size=4, prompt_size=512
policy_config:
  # === 核心参数 ===
  # 目标单实例 Decode TPS（每秒生成的 token 数）
  # - 11,369: 理论峰值（100% 利用率）
  # - 10,000: 平衡配置（88% 利用率，推荐）
  # - 9,000: 保守配置（80% 利用率，生产环境推荐）
  target_decode_tps_per_instance: 500  # 保守配置，留 20% 余量应对突发
  
  # P/D 比例（Prompt实例数 / Decode实例数）
  # - 2.0: 2个Prompt:1个Decode，适合代码生成（prompt_size≈512, token_size≈128）
  # - 1.5: 3个Prompt:2个Decode，通用平衡配置
  # - 1.0: 1个Prompt:1个Decode，适合长文本生成（token_size>256）
  pd_ratio: 2.0  # 推荐 2:1 比例，适合典型负载
  
  # 扩缩容阈值
  scale_out_threshold: 0.1  # 扩容阈值：当需求超过容量 10% 时扩容（ratio > 1.1）
  scale_in_threshold: 0.1   # 缩容阈值：当需求低于容量 10% 时缩容（ratio < 0.9）
  
  # === 延迟触发（紧急扩容）===
  enable_latency_trigger: true    # 启用延迟触发机制
  tbt_slo: 5                  # TBT SLO 五倍理想值
  latency_panic_threshold: 1.2    # 延迟触发阈值：TBT > 1.2×SLO 时紧急扩容
  latency_panic_scale_factor: 1.2 # 紧急扩容倍数：直接扩容 20%
  
  # === 实例数限制 ===
  min_instances_per_pool: 1    # 每个池最小实例数
  max_total_instances: 200     # 总实例数上限

# 调优建议（详见 doc/TPS_CALCULATION_SUMMARY.md）：
# 1. 如果 Token 实例利用率持续 >90%，降低 target_decode_tps_per_instance 到 8000
# 2. 如果 Prompt 实例利用率持续 >90%，增加 pd_ratio 到 2.5-3.0
# 3. 如果频繁触发紧急扩容，降低 target_decode_tps_per_instance 或调低 tbt_slo
